<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saif AI - Ø¯Ø±Ø¯Ø´Ø© Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-hue: 175;
      --primary-saturation: 70%;
      --primary-lightness: 40%;

      --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
      --primary-hover-color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) - 5%));
      --primary-glow-color: hsla(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%), 0.5);

      --bg-main: #181a1b;
      --bg-surface: #222526;
      --bg-surface-raised: #2c2f30;
      --bg-input: #2c2f30;

      --text-primary: #e8eaed;
      --text-secondary: #9aa0a6;
      --text-on-primary: #ffffff;
      
      --border-color: #3a3f42;
      --border-color-light: #4a4f52;
      
      --success-color: #34a853;
      --error-color: #ea4335;
      
      --user-message-bg: var(--primary-color);
      --bot-message-bg: var(--bg-surface-raised);

      --shadow-xs: 0 1px 2px rgba(0,0,0,0.25);
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.35);
      --shadow-lg: 0 10px 20px rgba(0,0,0,0.4);
      
      --border-radius-sm: 6px;
      --border-radius-md: 8px;
      --border-radius-lg: 12px;
      --border-radius-xl: 20px;

      /* Heights for bottom elements - REDUCED VALUES */
      --chat-input-area-height: 55px; /* ÙƒØ§Ù†Øª 70px */
      --status-bar-area-height: 22px; /* ÙƒØ§Ù†Øª 26px */
      --search-log-area-height: 18px; /* ÙƒØ§Ù†Øª 20px */

      --scroll-btn-size: 38px; /* ÙƒØ§Ù†Øª 40px */
      --scroll-btn-spacing: 8px; /* ÙƒØ§Ù†Øª 10px */
    }

    * {
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) var(--bg-surface);
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    *::-webkit-scrollbar-track {
      background: var(--bg-surface);
      border-radius: 3px;
    }
    *::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 3px;
    }

    html, body {
      height: 100%; 
      font-smooth: antialiased;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      background: var(--bg-main);
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
      overflow: hidden; 
    }

    .container {
      width: 100%;
      max-width: 760px; 
      height: 100vh; 
      background: var(--bg-main);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative; 
      box-shadow: var(--shadow-lg);
    }

    .header {
      background: var(--bg-surface);
      color: var(--text-primary);
      padding: 0.8rem 1.1rem; /* ÙŠÙ…ÙƒÙ† ØªÙ‚Ù„ÙŠÙ„ Ù‡Ø°Ø§ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ø§Ù… */
      text-align: center;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      position: relative; /* Ù…Ù‡Ù… Ù„Ù€ .delete-all-btn */
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      flex-shrink: 0; 
      z-index: 10; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ ÙÙˆÙ‚ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ¯Ø§Ø®Ù„ */
    }

    .header h1 {
      font-size: 1.3rem; 
      flex: 1;
      font-weight: 700;
      color: var(--primary-color); 
      letter-spacing: 0.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header .fas.fa-robot {
      font-size: 1.6rem;
      color: var(--primary-color);
      animation: pulseIcon 2s infinite ease-in-out;
    }

    @keyframes pulseIcon {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }

    .delete-all-btn {
      position: absolute;
      left: 15px; 
      top: 50%; /* Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø±Ø£Ø³ÙŠØ© Ø£ÙØ¶Ù„ */
      transform: translateY(-50%); /* Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø±Ø£Ø³ÙŠØ© Ø£ÙØ¶Ù„ */
      cursor: pointer;
      transition: color 0.2s ease-in-out, transform 0.2s ease;
      color: var(--text-secondary);
      font-size: 1.2rem; 
      z-index: 11; /* Ù„ÙŠÙƒÙˆÙ† ÙÙˆÙ‚ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± */
    }

    .delete-all-btn:hover {
      color: var(--error-color);
      transform: translateY(-50%) rotate(10deg) scale(1.1);
    }

    .chat-container {
      flex: 1;
      padding: 1rem 0.7rem; 
      overflow-y: auto;
      background: var(--bg-main);
      scroll-behavior: smooth; 
    }

    .message {
      margin-bottom: 1.1rem; 
      display: flex;
      flex-direction: column;
      animation: messageAppear 0.4s ease-out;
    }

    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(15px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message-header {
      font-size: 0.65rem; 
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      padding: 0 5px; 
    }

    .delete-btn {
      color: var(--text-secondary);
      font-size: 0.75rem; 
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
      opacity: 0.5; 
    }

    .delete-btn:hover {
      opacity: 1;
      color: var(--error-color);
      transform: scale(1.15);
    }

    .message.user {
      align-items: flex-end;
    }
    .message.user .message-header {
      flex-direction: row-reverse; 
    }

    .message.bot {
      align-items: flex-start;
    }

    .bubble {
      max-width: 78%; 
      padding: 0.75rem 1rem; 
      border-radius: var(--border-radius-md); 
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.6;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: var(--shadow-xs);
    }

    .message.user .bubble {
      background: var(--user-message-bg);
      color: var(--text-on-primary);
      border-bottom-right-radius: var(--border-radius-sm); 
    }

    .message.bot .bubble {
      background: var(--bot-message-bg);
      color: var(--text-primary);
      border-bottom-left-radius: var(--border-radius-sm); 
    }

    .message:hover .bubble {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .message-actions {
      margin-top: 6px;
      display: flex;
      gap: 5px; 
      padding: 0 5px; 
    }
    .message.user .message-actions { 
        justify-content: flex-end;
    }

    .message-actions button {
      background: transparent; 
      border: 1px solid var(--border-color-light); 
      cursor: pointer;
      font-size: 0.9rem; 
      padding: 4px 7px; 
      color: var(--text-secondary);
      transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      border-radius: var(--border-radius-sm);
    }

    .message-actions button:hover {
      color: var(--text-on-primary);
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      box-shadow: 0 0 8px var(--primary-glow-color);
    }

    .message-actions button.liked {
      color: var(--success-color);
      border-color: var(--success-color);
    }
     .message-actions button.liked:hover {
      background-color: var(--success-color);
      color: var(--text-on-primary);
      box-shadow: 0 0 8px hsla(135, 60%, 50%, 0.5);
    }

    .chat-input {
      display: flex;
      align-items: flex-end; 
      border-top: 1px solid var(--border-color);
      padding: 0.5rem 0.7rem; /* ÙƒØ§Ù†Øª 0.6rem 0.75rem */
      background: var(--bg-surface); 
      gap: 0.6rem; 
      position: relative; 
      z-index: 5; 
      flex-shrink: 0; 
      min-height: var(--chat-input-area-height); 
    }

    .chat-input textarea {
      flex: 1;
      padding: 0.6rem 0.9rem; /* ÙƒØ§Ù†Øª 0.7rem 1rem */
      border: 1px solid var(--border-color);
      resize: none;
      font-size: 0.9rem;
      outline: none;
      border-radius: var(--border-radius-xl); 
      background: var(--bg-input);
      color: var(--text-primary);
      max-height: 90px; /* ÙƒØ§Ù†Øª 110px */
      line-height: 1.55;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
     .chat-input textarea::placeholder {
        color: var(--text-secondary);
        opacity: 0.6;
     }
     .chat-input textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-glow-color);
     }

    .chat-input-btn { 
      background: var(--primary-color);
      border: none;
      color: var(--text-on-primary);
      width: 38px; /* ÙƒØ§Ù†Øª 40px */
      height: 38px; /* ÙƒØ§Ù†Øª 40px */
      border-radius: 50%; 
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem; 
      transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
      flex-shrink: 0; 
    }
    .chat-input-btn:hover {
      background: var(--primary-hover-color);
      transform: scale(1.05);
      box-shadow: 0 0 10px var(--primary-glow-color);
    }
    .chat-input-btn:active {
        transform: scale(0.92);
        background: var(--primary-hover-color);
    }

    #imageUpload {
      display: none;
    }
    
    .upload-options-container {
      position: absolute;
      bottom: calc(100% + 5px); 
      right: 48px; /* ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø­Ø¬Ù… Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
      background-color: var(--bg-surface-raised);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding: 8px;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: opacity 0.2s ease, visibility 0s linear 0.2s, transform 0.2s ease;
    }
    .upload-options-container.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      transition: opacity 0.2s ease, visibility 0s linear 0s, transform 0.2s ease;
    }
    .upload-options-container button {
      background-color: var(--bg-input);
      color: var(--text-secondary);
      border: 1px solid var(--border-color-light);
      padding: 8px 12px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .upload-options-container button:hover {
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border-color: var(--primary-color);
    }
    .upload-options-container button i {
      font-size: 1rem;
    }

    .status {
      text-align: center;
      padding: 0.25rem; /* ÙƒØ§Ù†Øª 0.3rem */
      font-size: 0.75rem; 
      background-color: var(--bg-surface);
      color: var(--text-secondary);
      border-top: 1px solid var(--border-color);
      min-height: var(--status-bar-area-height); 
      transition: color 0.3s ease;
      flex-shrink: 0; 
    }

    .status.success { color: var(--success-color); font-weight: 500; }
    .status.error { color: var(--error-color); font-weight: 500; }

    a {
      color: var(--primary-color); 
      text-decoration: none;
      word-break: break-all;
      font-weight: 500;
    }

    a:hover {
      text-decoration: underline;
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%)); 
    }

    .search-log {
      text-align: center;
      font-size: 0.7rem; 
      color: var(--text-secondary);
      opacity: 0.6; 
      padding: 0.1rem 0; /* ÙƒØ§Ù†Øª 0.15rem 0 */
      border-top: 1px dashed var(--border-color-light);
      background-color: var(--bg-main);
      min-height: var(--search-log-area-height);
      flex-shrink: 0; 
    }

    .toggle-details-btn {
      cursor: pointer;
      color: var(--primary-color);
      font-weight: 500;
      border: none;
      background: none;
      padding: 0;
      margin-top: 8px;
      display: block; 
      text-align: right; 
      font-size: 0.85rem;
      transition: color 0.2s ease;
    }

    .toggle-details-btn:hover {
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%)); 
      text-decoration: underline;
    }

    .camera-modal {
        display: none; 
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
        align-items: center;
        justify-content: center;
    }
    .camera-modal-content {
        background-color: var(--bg-surface);
        padding: 20px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        text-align: center;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    #cameraView {
        width: 100%;
        max-width: 400px;
        height: auto;
        border-radius: var(--border-radius-md);
        margin-bottom: 15px;
        background-color: #000; 
    }
    .camera-controls button {
        background: var(--primary-color);
        border: none;
        color: var(--text-on-primary);
        padding: 10px 20px;
        font-size: 0.9rem;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        margin: 0 5px;
        transition: background-color 0.2s ease;
    }
    .camera-controls button:hover {
        background: var(--primary-hover-color);
    }
    .camera-controls button#cancelCameraBtn {
        background-color: var(--error-color);
    }
    .camera-controls button#cancelCameraBtn:hover {
        background-color: hsl(var(--primary-hue,0), 90%, 30%); 
    }

    .scroll-btn {
      position: absolute; 
      right: 20px;
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border: none;
      width: var(--scroll-btn-size);   
      height: var(--scroll-btn-size);  
      border-radius: 50%;
      display: none; 
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem; 
      box-shadow: var(--shadow-md);
      transition: background-color 0.2s ease, transform 0.2s ease, opacity 0.3s ease, visibility 0.3s ease;
      z-index: 3; 
      opacity: 0;
      visibility: hidden;
    }
    .scroll-btn:hover {
      background-color: var(--primary-hover-color);
      transform: scale(1.1);
    }
    .scroll-btn.visible {
        display: flex;
        opacity: 0.8; 
        visibility: visible;
    }
    .scroll-btn.visible:hover {
        opacity: 1; 
    }

    /* ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ø¶Ø¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
    #scrollToBottomBtn {
      bottom: calc(var(--chat-input-area-height) + var(--status-bar-area-height) + var(--search-log-area-height) + var(--scroll-btn-spacing));
    }
    #scrollToTopBtn {
      bottom: calc(var(--chat-input-area-height) + var(--status-bar-area-height) + var(--search-log-area-height) + var(--scroll-btn-spacing) + var(--scroll-btn-size) + var(--scroll-btn-spacing));
    }


    @media (max-width: 768px) {
      .container {
        border-radius: 0; 
        border-left: none;
        border-right: none;
        max-width: 100%; 
      }
      :root {
        --chat-input-area-height: 52px; 
        --status-bar-area-height: 20px;
        --search-log-area-height: 16px;
        --scroll-btn-size: 36px;
        --scroll-btn-spacing: 7px;
      }
      .header { padding: 0.7rem 1rem; }
      .header h1 { font-size: 1.2rem; }
      .header .fas.fa-robot { font-size: 1.5rem; }
      .delete-all-btn { font-size: 1.1rem; }
      .bubble { max-width: 85%; padding: 0.65rem 0.9rem; line-height: 1.55; }
      
      .chat-input { padding: 0.4rem 0.6rem; gap: 0.5rem; } /* ØªØ¹Ø¯ÙŠÙ„ Ø·ÙÙŠÙ */
      .chat-input textarea { font-size: 0.85rem; padding: 0.5rem 0.8rem; } /* ØªØ¹Ø¯ÙŠÙ„ Ø·ÙÙŠÙ */
      .chat-input-btn { width: 36px; height: 36px; font-size: 0.9rem; } /* ØªØ¹Ø¯ÙŠÙ„ Ø·ÙÙŠÙ */
      .upload-options-container { right: 43px; } /* ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø­Ø¬Ù… Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
      .upload-options-container button { padding: 7px 10px; font-size: 0.8rem; }
    }

    @media (max-width: 480px) {
      :root {
        --chat-input-area-height: 50px; 
        --status-bar-area-height: 18px;
        --search-log-area-height: 15px;
        --scroll-btn-size: 34px;
        --scroll-btn-spacing: 5px;
      }
      .header { padding: 0.6rem 0.8rem; gap: 0.5rem; }
      .header h1 { font-size: 1.1rem; }
      .header .fas.fa-robot { font-size: 1.3rem; }
      .delete-all-btn { font-size: 1rem; left: 10px; }
      .chat-container { padding: 0.8rem 0.5rem; }
      .message-header { font-size: 0.6rem; gap: 4px; }
      .bubble { max-width: 90%; padding: 0.6rem 0.8rem; line-height: 1.5; }
      .message.user .bubble { border-bottom-right-radius: 4px; }
      .message.bot .bubble { border-bottom-left-radius: 4px; }
      .message-actions button { font-size: 0.8rem; padding: 3px 6px; }
      
      .chat-input { padding: 0.35rem 0.45rem; gap: 0.4rem; }
      .chat-input textarea { font-size: 0.8rem; padding: 0.45rem 0.7rem; max-height: 80px; }
      .chat-input-btn { width: 34px; height: 34px; font-size: 0.85rem; }
      .upload-options-container { right: 40px; } /* ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø­Ø¬Ù… Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
      .upload-options-container button { padding: 6px 8px; font-size: 0.75rem; }
      .upload-options-container button i { font-size: 0.9rem; }
      .status { font-size: 0.7rem; padding: 0.25rem;}
      .search-log { font-size: 0.65rem; padding: 0.1rem 0;}
      .scroll-btn { right: 15px; }
      .toggle-details-btn { font-size: 0.8rem; }
    }

    @media (max-width: 360px) {
       :root {
        --chat-input-area-height: 48px;
        --status-bar-area-height: 18px; /* Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø§Ø¨Ù‚Ø§Ø¦Ù‡Ø§ Ø£Ùˆ ØªÙ‚Ù„ÙŠÙ„Ù‡Ø§ Ø£ÙƒØ«Ø± Ø¨Ø­Ø°Ø± */
        --search-log-area-height: 14px;
        --scroll-btn-size: 32px;
       }
      .header h1 { font-size: 1rem; }
      .bubble { padding: 0.5rem 0.7rem; }
      .chat-input textarea { padding: 0.35rem 0.6rem; }
      .chat-input-btn { width: 32px; height: 32px; }
      .upload-options-container { right: 38px; } /* ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø­Ø¬Ù… Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <i class="fas fa-trash delete-all-btn" onclick="deleteAllMessages()" title="Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„"></i>
      <i class="fas fa-robot"></i>
      <h1 id="botName">Saif AI</h1>
    </header>

    <div id="chatContainer" class="chat-container">
      <!-- Messages will be here -->
    </div>

    <button id="scrollToTopBtn" class="scroll-btn" title="Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰">
      <i class="fas fa-arrow-up"></i>
    </button>
    <button id="scrollToBottomBtn" class="scroll-btn" title="Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„">
      <i class="fas fa-arrow-down"></i>
    </button>

    <div id="searchLog" class="search-log"></div>
    <div class="status" id="statusBar"></div>

    <div class="chat-input">
      <textarea id="userInput" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
      
      <div class="upload-options-container" id="uploadOptionsContainer">
        <button onclick="triggerImageUpload()">
          <i class="fas fa-images"></i> Ø±ÙØ¹ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶
        </button>
        <button onclick="openCamera()">
          <i class="fas fa-camera"></i> Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        </button>
      </div>
      
      <button class="chat-input-btn" id="toggleUploadBtn" title="Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù">
        <i class="fas fa-plus"></i>
      </button>
      
      <button class="chat-input-btn" onclick="sendMessage()" title="Ø¥Ø±Ø³Ø§Ù„">
        <i class="fas fa-paper-plane"></i>
      </button>
      <input id="imageUpload" type="file" accept="image/*" onchange="handleFileSelect(event)" />
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal" class="camera-modal">
    <div class="camera-modal-content">
      <video id="cameraView" autoplay playsinline></video>
      <div class="camera-controls">
        <button id="captureBtn">Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</button>
        <button id="cancelCameraBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <script> 
    const geminiApiKey = "AIzaSyBUqzhaui0pz0PqhCsVEpQYfOHsCYKtPBk"; 
    const ocrApiKey = "K83201031288957";    

    const chatContainer = document.getElementById("chatContainer"); 
    const statusBar = document.getElementById("statusBar"); 
    const searchLog = document.getElementById("searchLog"); 
    const userInput = document.getElementById("userInput"); 
    const botNameElement = document.getElementById("botName");
    const imageUploadInput = document.getElementById("imageUpload");
    const toggleUploadBtn = document.getElementById("toggleUploadBtn");
    const uploadOptionsContainer = document.getElementById("uploadOptionsContainer");
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');

    const cameraModal = document.getElementById('cameraModal');
    const cameraView = document.getElementById('cameraView');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');
    let cameraStream = null;

    const botName = "Ø³ÙŠÙ AI"; 
    const localStorageKeyMessages = "saifAiChatHistory"; 
    const localStorageKeyAdCounter = "saifAiAdCounter"; 
    const localStorageKeyImageUploadDate = "saifAiImageUploadDate"; 
    const localStorageKeyImageUploadCount = "saifAiImageUploadCount"; 

    const AD_URL = "https://www.profitableratecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e";
    const AD_DELAY_MS = 10000; 

    let messages = []; 
    let successfulResponseCount = 0; 
    let userMessageCounterForAds = 0; 
    let statusTimeout; 

    function initializeApp() { 
        const storedAdCount = localStorage.getItem(localStorageKeyAdCounter); 
        if (storedAdCount) { 
            successfulResponseCount = parseInt(storedAdCount, 10) || 0; 
        } 
        loadMessagesFromLocalStorage(); 
        botNameElement.textContent = botName; 
        addWelcomeMessage(); 
        refreshChat(); 
        autoResizeTextarea(); 

        toggleUploadBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            uploadOptionsContainer.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (!uploadOptionsContainer.contains(e.target) && !toggleUploadBtn.contains(e.target)) {
                uploadOptionsContainer.classList.remove('active');
            }
        });

        captureBtn.addEventListener('click', captureImageFromCamera);
        cancelCameraBtn.addEventListener('click', closeCamera);

        scrollToTopBtn.addEventListener('click', () => {
            chatContainer.scrollTo({ top: 0, behavior: 'smooth' });
        });

        scrollToBottomBtn.addEventListener('click', () => {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        });

        chatContainer.addEventListener('scroll', () => {
            const scrollTop = chatContainer.scrollTop;
            const scrollHeight = chatContainer.scrollHeight;
            const clientHeight = chatContainer.clientHeight;
            const scrollThreshold = 150; 

            if (scrollTop > scrollThreshold) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }

            if (scrollHeight > clientHeight && scrollHeight - scrollTop - clientHeight > scrollThreshold) {
                scrollToBottomBtn.classList.add('visible');
            } else {
                scrollToBottomBtn.classList.remove('visible');
            }
        });
         // Initial check for scroll buttons visibility
        chatContainer.dispatchEvent(new Event('scroll'));
    } 

    function loadMessagesFromLocalStorage() { 
        const storedMessages = localStorage.getItem(localStorageKeyMessages); 
        if (storedMessages) { 
            try { 
                const parsedMessages = JSON.parse(storedMessages); 
                messages = parsedMessages.map(msg => ({ 
                    ...msg, 
                    timestamp: new Date(msg.timestamp) 
                })); 
            } catch (e) { 
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ:", e); 
                messages = []; 
                localStorage.removeItem(localStorageKeyMessages); 
            } 
        } 
    } 

    function saveMessagesToLocalStorage() { 
        localStorage.setItem(localStorageKeyMessages, JSON.stringify(messages)); 
    } 

    function addWelcomeMessage() { 
      const welcomeMsg = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ ' + botName + 'ØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ Ø±ÙØ¹ ØµÙˆØ±ØªÙŠÙ† ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙˆØ³Ø£Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù†Ù‡Ù…Ø§ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„ØªØ­Ù„ÙŠÙ„.'; 
      if (!messages.some(m => m.text === welcomeMsg && m.sender === "bot")) { 
        addMessage("bot", welcomeMsg, false, true, true /* isInitialWelcome */); 
      } 
    } 

    function addMessage(sender, text, isImage = false, isSystemMessage = false, isInitialWelcome = false) { 
      const message = { sender, text, isImage, isSystemMessage, timestamp: new Date() }; 
      messages.push(message); 
      
      const wasNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 150;

      refreshChat(); 

      if (sender === 'user') {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      } else if (isInitialWelcome) { 
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      } else if (wasNearBottom && !isImage) { 
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }
    } 

    function linkifyAndFormatText(text) {
      if (typeof text !== 'string') return ''; 
      const linkedText = text.replace(/(https?:\/\/[^\s!"#$%&'()*+,\-./:;<=>?@[\\\]^_`{|}~]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      return linkedText.replace(/\n/g, '<br>'); 
    } 

    function refreshChat() { 
      chatContainer.innerHTML = ""; 
      messages.forEach((msg, index) => { 
        const messageElem = document.createElement("div"); 
        messageElem.classList.add("message", msg.sender); 
        
        const header = document.createElement("div"); 
        header.classList.add("message-header"); 
        header.innerHTML = `<span>${msg.sender === "bot" ? (msg.isSystemMessage ? botName + " (Ù†Ø¸Ø§Ù…)" : botName) : "Ø£Ù†Øª"}</span>`; 
        
        const deleteBtn = document.createElement("i"); 
        deleteBtn.className = "fas fa-trash delete-btn"; 
        deleteBtn.title = "Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©"; 
        deleteBtn.onclick = () => deleteMessage(index); 
        header.appendChild(deleteBtn); 
        
        messageElem.appendChild(header); 
        
        const bubble = document.createElement("div"); 
        bubble.classList.add("bubble"); 

        if(msg.isImage) { 
          const img = document.createElement("img"); 
          img.src = msg.text; 
          img.style.maxWidth = "100%"; 
          img.style.maxHeight = "300px"; 
          img.style.borderRadius = "var(--border-radius-sm)"; 
          img.alt = "ØµÙˆØ±Ø© Ù…Ø±Ø³Ù„Ø©"; 
          img.onload = () => { 
              const wasNearBottomForImage = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 150;
              if (wasNearBottomForImage) {
                  chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }); 
              }
          } 
          img.onerror = () => { 
              console.warn("Failed to load image:", msg.text);
          }
          bubble.appendChild(img); 
        } else { 
          const originalText = msg.text; 
          const characterLimit = 250; 

          if (msg.sender === "bot" && !msg.isSystemMessage && originalText.length > characterLimit) { 
            const shortText = originalText.substring(0, characterLimit) + "..."; 
            const contentContainer = document.createElement('div'); 
            const textSpan = document.createElement('span'); 
            textSpan.innerHTML = linkifyAndFormatText(shortText); 
            contentContainer.appendChild(textSpan); 

            const toggleButton = document.createElement('button'); 
            toggleButton.textContent = "Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„"; 
            toggleButton.className = "toggle-details-btn"; 
            toggleButton.dataset.expanded = "false"; 

            toggleButton.onclick = function() {
              const isExpanded = toggleButton.dataset.expanded === "true"; 
              if (isExpanded) { 
                textSpan.innerHTML = linkifyAndFormatText(shortText); 
                toggleButton.textContent = "Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„"; 
                toggleButton.dataset.expanded = "false"; 
              } else { 
                textSpan.innerHTML = linkifyAndFormatText(originalText); 
                toggleButton.textContent = "Ø¹Ø±Ø¶ Ø£Ù‚Ù„"; 
                toggleButton.dataset.expanded = "true"; 
              } 
            }; 
            contentContainer.appendChild(toggleButton); 
            bubble.appendChild(contentContainer); 
          } else { 
            bubble.innerHTML = linkifyAndFormatText(originalText); 
          } 
        } 
        messageElem.appendChild(bubble); 
        
        if(msg.sender === "bot" && !msg.isImage && !msg.isSystemMessage) {
          const actionsDiv = document.createElement("div"); 
          actionsDiv.classList.add("message-actions"); 
          
          const likeBtn = document.createElement("button"); 
          likeBtn.innerHTML = '<i class="fas fa-thumbs-up"></i>'; 
          likeBtn.title = "Ø¥Ø¹Ø¬Ø§Ø¨"; 
          likeBtn.addEventListener("click", (e) => e.currentTarget.classList.toggle("liked")); 
          
          const copyBtn = document.createElement("button"); 
          copyBtn.innerHTML = '<i class="fas fa-copy"></i>'; 
          copyBtn.title = "Ù†Ø³Ø® Ø§Ù„Ù†Øµ"; 
          copyBtn.addEventListener("click", () => { 
            navigator.clipboard.writeText(msg.text) 
            .then(() => setStatus("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‘", "success", 1500)) 
            .catch(err => setStatus("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®: " + err.message, "error", 2000)); 
          }); 
          
          actionsDiv.appendChild(likeBtn); 
          actionsDiv.appendChild(copyBtn); 
          messageElem.appendChild(actionsDiv); 
        } 
        
        chatContainer.appendChild(messageElem); 
      }); 

      saveMessagesToLocalStorage(); 
      autoResizeTextarea(); 
      // Ensure scroll buttons update their visibility after refresh
      chatContainer.dispatchEvent(new Event('scroll'));
    } 

    function deleteMessage(index) { 
      messages.splice(index, 1);
      refreshChat(); 
      setStatus("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©.", "success", 1500); 
    } 

    function deleteAllMessages() { 
      if (messages.length === 0 || (messages.length === 1 && messages[0].text.includes('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!'))) { 
        setStatus("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù„Ø­Ø°ÙÙ‡Ø§.", "", 1500); 
        return; 
      } 
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) { 
        messages = []; 
        refreshChat(); 
        setStatus("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­.", "success", 2000); 
        addWelcomeMessage(); 
      } 
    } 
    
    function setStatus(message, type = "", duration = 3000) { 
      clearTimeout(statusTimeout); 
      statusBar.textContent = message; 
      statusBar.className = "status " + type; 
      if (message && duration !== null) { 
        statusTimeout = setTimeout(() => { 
          statusBar.textContent = ""; 
          statusBar.className = "status"; 
        }, duration); 
      } else if (!message) { 
         statusBar.textContent = ""; 
         statusBar.className = "status"; 
      } 
    } 

    function triggerImageUpload() {
        uploadOptionsContainer.classList.remove('active');
        imageUploadInput.click();
    }

    function handleFileSelect(event) { 
        if (event.target.type === 'file' && event.target.files && event.target.files[0]) {
            const file = event.target.files[0];
            processAndUploadImageFile(file);
            event.target.value = ""; 
        }
    }
    
    async function processAndUploadImageFile(file) {
        if (!checkImageUploadLimit()) return;

        setTimeout(() => {
            window.open(AD_URL, '_blank');
            console.log("ØªÙ… ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø³Ø¨Ø¨ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© (Ø¨Ø¹Ø¯ ~10 Ø«ÙˆØ§Ù†Ù).");
        }, AD_DELAY_MS);

        if (file.size > 5 * 1024 * 1024) { 
            setStatus("Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª).", "error", 3000);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            addMessage("user", e.target.result, true); 
            extractTextFromImageAndProcess(file); 
        }
        reader.readAsDataURL(file);
        
        incrementImageUploadCount();
    }

    function checkImageUploadLimit() {
        const today = new Date().toISOString().split('T')[0];
        const lastUploadDate = localStorage.getItem(localStorageKeyImageUploadDate);
        let uploadCount = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");

        if (lastUploadDate === today) {
            if (uploadCount >= 2) { 
                setStatus("Ù„Ù‚Ø¯ ØªØ¹Ø¯ÙŠØª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… (ØµÙˆØ±ØªØ§Ù†).", "error", 4000);
                addMessage("bot", "Ø¹ÙÙˆØ§Ù‹, Ù„Ù‚Ø¯ Ø§Ø³ØªÙ†ÙØ°Øª Ø­ØµØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù…Ù† Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± (ØµÙˆØ±ØªØ§Ù†). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ØºØ¯Ø§Ù‹.", false, true);
                return false;
            }
        } else {
            localStorage.setItem(localStorageKeyImageUploadDate, today);
            localStorage.setItem(localStorageKeyImageUploadCount, "0");
            uploadCount = 0;
        }
        return true;
    }

    function incrementImageUploadCount() {
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem(localStorageKeyImageUploadDate, today); 
        let currentCount = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");
        localStorage.setItem(localStorageKeyImageUploadCount, (currentCount + 1).toString());
    }


    async function extractTextFromImageAndProcess(file) { 
        if (!ocrApiKey || ocrApiKey === "YOUR_OCR_SPACE_API_KEY" ) { 
            addMessage("bot", "Ù…ÙŠØ²Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ± ØºÙŠØ± Ù…ÙØ¹Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø¹Ø¯Ù… ØªÙƒÙˆÙŠÙ† Ù…ÙØªØ§Ø­ OCR.", false, true);
            setStatus("Ù…ÙØªØ§Ø­ OCR ØºÙŠØ± Ù…ÙƒÙˆÙ‘Ù†.", "error", 5000);
            return; 
        }

        setStatus(`Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù†Ù‡Ø§...`, "", null);
        const formData = new FormData();
        formData.append('apikey', ocrApiKey);
        formData.append('language', 'ara'); 
        formData.append('isOverlayRequired', 'false');
        formData.append('file', file);

        try {
            const ocrResponse = await fetch('https://api.ocr.space/parse/image', {
                method: 'POST',
                body: formData,
            });

            if (!ocrResponse.ok) {
                const errorData = await ocrResponse.json();
                console.error("Ø®Ø·Ø£ Ù…Ù† OCR.space:", errorData);
                throw new Error(`ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ: ${errorData.ErrorMessage || ocrResponse.statusText}`);
            }

            const ocrData = await ocrResponse.json();

            if (ocrData.IsErroredOnProcessing) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© OCR:", ocrData.ErrorMessage);
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©: ${ocrData.ErrorMessage.join(', ')}`);
            }
            
            if (ocrData.ParsedResults && ocrData.ParsedResults.length > 0 && ocrData.ParsedResults[0].ParsedText.trim() !== "") {
                const extractedText = ocrData.ParsedResults[0].ParsedText.trim();
                addMessage("bot", `ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©:\n"${extractedText}"`, false, true); 
                setStatus("ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„ØªØ­Ù„ÙŠÙ„...", "success", 2500);
                await processQueryWithAI(extractedText); 
            } else {
                addMessage("bot", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Øµ ÙˆØ§Ø¶Ø­ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ Ø£Ù† Ø§Ù„Ù†Øµ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….", false, true);
                setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©.", "error", 3000);
            }
        } catch (error) {
            console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©:", error);
            addMessage("bot", `Ø¹ÙÙˆØ§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©. ${error.message}`, false, true);
            setStatus("ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©.", "error", 4000);
        }
    }
    
    function generateChatPrompt(userMessage) { 
      const maxHistoryMessages = 8; 
      let relevantHistory = ""; 
      const textMessages = messages.filter(m => !m.isImage && !(m.sender === 'bot' && m.isSystemMessage)); 
      
      const systemPrompt = `Ø£Ù†Øª ${botName}ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ¯ÙˆØ¯ØŒ ØµØ§Ø¯Ù‚ØŒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠØŒ ÙˆØ°ÙƒÙŠ Ø¬Ø¯Ø§Ù‹. Ù‡Ø¯ÙÙƒ Ù‡Ùˆ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙ‡ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ¨Ø·Ø±ÙŠÙ‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆÙ…ÙØµÙ„Ø©. ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù‚ØªØ¶Ø¨Ø© Ø¬Ø¯Ø§Ù‹ ÙˆØ­Ø§ÙˆÙ„ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø­Ø§Ø¯Ø«ØªÙƒ Ø¬Ø°Ø§Ø¨Ø©. Ø¥Ø°Ø§ Ù„Ù… ØªØ¹Ø±Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŒ Ù‚Ù„ Ø°Ù„Ùƒ Ø¨ØµØ±Ø§Ø­Ø© ÙˆÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ù† Ø£Ù…ÙƒÙ†. Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¶ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø§Ø³Ø¨ ÙˆÙ„ÙƒÙ† Ø¨Ù„Ù…Ø³Ø© Ø¨Ø³ÙŠØ·Ø©. Ø¥Ø°Ø§ Ø³Ø£Ù„Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "Ù…Ù† ØµÙ†Ø¹Ùƒ" Ø£Ùˆ "Ù…ÙŠÙ† Ø¹Ù…Ù„Ùƒ" Ø£Ùˆ "Ù…Ù† Ù‡Ùˆ Ù…Ø·ÙˆØ±Ùƒ" Ø£Ùˆ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ù…Ø´Ø§Ø¨Ù‡ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹ "Ø£Ù†Ø§ Ù…Ù† ØµÙ†Ø¹ Ø³ÙŠÙ Ù‡Ø§Ù†ÙŠ".\n\n`; 

      const startIndex = Math.max(0, textMessages.length - maxHistoryMessages);
      for (let i = startIndex; i < textMessages.length; i++) { 
        const msg = textMessages[i]; 
        if (msg.sender === "bot" && msg.text.includes('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ ' + botName) && textMessages.filter(m => m.sender === 'bot').length === 1 && messages.length <= maxHistoryMessages +1) { 
            continue; 
        } 
        relevantHistory += (msg.sender === "user" ? "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " : botName + ": ") + msg.text + "\n"; 
      } 
      
      return `${systemPrompt}${relevantHistory}Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userMessage}\n${botName}:`; 
    } 

    async function fetchGeminiResponse(prompt) { 
      if (!geminiApiKey || geminiApiKey === "YOUR_GEMINI_API_KEY") { 
          console.error("Gemini API Key is not configured or is a placeholder.");
          return "Ø¹ÙÙˆØ§Ù‹ØŒ Ø®Ø¯Ù…Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØºÙŠØ± Ù…ÙƒÙˆÙ‘Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙØªØ§Ø­ API.";
      }

      const requestBody = { 
        contents: [{ parts: [{ text: prompt }] }], 
      }; 

      try { 
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify(requestBody) 
        }); 

        if(!response.ok) { 
          const errorData = await response.json(); 
          console.error("Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø®Ø·Ø£ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª Gemini:", errorData); 
          let errorMessage = ` Ø®Ø·Ø£ ${response.status}: ${response.statusText}.`; 
          if (errorData.error && errorData.error.message) { 
             if (errorData.error.message.toLowerCase().includes("api key") || errorData.error.message.toLowerCase().includes("permission")) { 
                errorMessage += " Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ÙØªØ§Ø­ Gemini."; 
             } else { 
                errorMessage += ` Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${errorData.error.message.substring(0, 200)}`; 
             } 
          } 
          throw new Error(errorMessage); 
        } 
        const data = await response.json(); 
        
        if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) { 
          return data.candidates[0].content.parts[0].text; 
        } else if (data.promptFeedback?.blockReason) { 
            console.warn("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨ÙˆØ§Ø³Ø·Ø© ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª Gemini:", data.promptFeedback.blockReason, data.promptFeedback.safetyRatings); 
            return `Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Gemini (Ø§Ù„Ø³Ø¨Ø¨: ${data.promptFeedback.blockReason}). Ø­Ø§ÙˆÙ„ ØªØºÙŠÙŠØ± Ø³Ø¤Ø§Ù„Ùƒ.`; 
        } else if (data.candidates && data.candidates[0]?.finishReason) { 
            let botMessage = (data.candidates[0].content?.parts?.[0]?.text || ""); 
            const reason = data.candidates[0].finishReason; 
            if (reason === "SAFETY") {
                return botMessage + (botMessage ? "\n\n" : "") + "Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ù…Ù† Gemini. Ø­Ø§ÙˆÙ„ ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¤Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹."; 
            } else if (reason === "MAX_TOKENS") { 
                return botMessage + "\n\n(ØªÙ… Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø±Ø¯ Ù„Ø£Ù†Ù‡ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·ÙˆÙ„ Ù…Ù† Gemini)"; 
            } else { 
                 console.warn("Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª Gemini Ù…Ø¹ finishReason ÙˆÙ„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ù…Ø­ØªÙˆÙ‰ ÙƒØ§ÙÙ:", reason, data); 
                 return botMessage + (botMessage ? "\n\n" : "") + `Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø¯ Ù…ÙƒØªÙ…Ù„ Ù…Ù† Gemini (Ø§Ù„Ø³Ø¨Ø¨: ${reason}).`; 
            } 
        } else { 
          console.warn("ØªÙ†Ø³ÙŠÙ‚ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª Gemini ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:", data); 
          return "Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø¯ ØµØ­ÙŠØ­ Ù…Ù† Ø®Ø§Ø¯Ù… Gemini. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø¯ ØºÙŠØ± ÙƒØ§Ù…Ù„ Ø£Ùˆ Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø©."; 
        } 
      } catch (error) { 
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Gemini:", error); 
          if (error.message && (error.message.toLowerCase().includes("api key") || error.message.toLowerCase().includes(geminiApiKey.toLowerCase()))) { 
              throw new Error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Gemini. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„."); 
          } 
          throw error; 
      } 
    } 

    async function processQueryWithAI(queryText) {
        if (!queryText) return;
        
        searchLog.textContent = `Ø¢Ø®Ø± Ø§Ø³ØªØ¹Ù„Ø§Ù…: ${queryText.substring(0, 60)}${queryText.length > 60 ? '...' : ''}`; 
        setStatus(`${botName} ÙŠÙÙÙƒØ± Ø¨Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…: "${queryText.substring(0,30)}..."`, "", null);

        try {
            const prompt = generateChatPrompt(queryText);
            const responseText = await fetchGeminiResponse(prompt);
            addMessage("bot", responseText);
            setStatus("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­! âœ…", "success");

            successfulResponseCount++;
            localStorage.setItem(localStorageKeyAdCounter, successfulResponseCount.toString());

        } catch (error) {
            console.error("ØªÙØ§ØµÙŠÙ„ Ø®Ø·Ø£ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Gemini:", error);
            let displayError = "Ø¹ÙÙˆÙ‹Ø§ØŒ ÙˆØ§Ø¬Ù‡Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Gemini. ğŸ˜¥";
            if (error.message && !error.message.toLowerCase().includes("api key") && !error.message.toLowerCase().includes("api_key") && !error.message.toLowerCase().includes(geminiApiKey.toLowerCase())) {
                displayError += " Ø§Ù„ØªÙØ§ØµÙŠÙ„: " + error.message;
            }
            addMessage("bot", displayError);
            setStatus("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯ Ù…Ù† Gemini. âŒ", "error");
        }
    }

    async function sendMessage() { 
      const messageText = userInput.value.trim(); 
      if (!messageText) return; 

      addMessage("user", messageText); 
      userInput.value = ""; 
      autoResizeTextarea(); 

      userMessageCounterForAds++;
      if (userMessageCounterForAds % 2 === 0) {
        setTimeout(() => {
            window.open(AD_URL, '_blank');
            console.log(`ØªÙ… ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø±Ù‚Ù… ${userMessageCounterForAds} Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….`);
        }, 500); 
      }
      
      await processQueryWithAI(messageText);
    } 

    userInput.addEventListener("keydown", function(event) { 
      if(event.key === "Enter" && !event.shiftKey) { 
        event.preventDefault(); 
        sendMessage(); 
      } 
    }); 
    userInput.addEventListener("input", autoResizeTextarea); 
    
    function autoResizeTextarea() { 
        userInput.style.height = 'auto'; 
        let newHeight = userInput.scrollHeight; 
        const maxHeight = parseInt(getComputedStyle(userInput).maxHeight) || 90; // Update to new max-height
        
        if (newHeight > maxHeight) { 
            newHeight = maxHeight; 
            userInput.style.overflowY = 'auto'; 
        } else { 
            userInput.style.overflowY = 'hidden'; 
        } 
        userInput.style.height = newHeight + 'px'; 
    } 
    
    async function openCamera() {
        uploadOptionsContainer.classList.remove('active');
        if (!checkImageUploadLimit()) return; 

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                cameraView.srcObject = cameraStream;
                cameraModal.style.display = "flex";
            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", err);
                setStatus("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.", "error", 4000);
                addMessage("bot", "Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ Ø³Ù…Ø­Øª Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.", false, true);
            }
        } else {
            setStatus("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.", "error", 4000);
            addMessage("bot", "Ø¹ÙÙˆØ§Ù‹ØŒ ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…ÙŠØ²Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.", false, true);
        }
    }

    function closeCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        cameraView.srcObject = null;
        cameraModal.style.display = "none";
    }

    async function captureImageFromCamera() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraView.videoWidth;
        canvas.height = cameraView.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(cameraView, 0, 0, canvas.width, canvas.height);
        
        closeCamera(); 

        canvas.toBlob(async (blob) => {
            if (blob) {
                const capturedFile = new File([blob], `capture-${Date.now()}.jpg`, { type: 'image/jpeg' });
                await processAndUploadImageFile(capturedFile); 
            } else {
                 setStatus("ÙØ´Ù„ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©.", "error", 3000);
                 addMessage("bot", "Ø¹ÙÙˆØ§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©.", false, true);
            }
        }, 'image/jpeg', 0.9); 
    }

    initializeApp(); 
  </script>
</body> 
</html>
